# This is a basic workflow to help you get started with Actions
name: Pipeline Deploy

# Controls when the workflow will run
on:  
  push:    
    branches: [ "main" ]  
  pull_request:    
    branches: [ "main" ]  
  workflow_dispatch:

jobs:  
    build:
      runs-on: macos-latest
      steps:
        - uses: actions/checkout@v4

        - name: Install Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '18.4.0'
            cache: 'npm'
            
        - name: Install Cordova
          run: npm install -g cordova

        - name: Install NPM
          run: npm install

        - name: Remove Xcode
          run: cordova platform rm ios

        - name: Create Xcode Project
          run: cordova platform add ios

        - name: Build Xcode Project        
          run: |
            xcodebuild -workspace "WeSign QA.xcworkspace" -scheme "WeSign QA" -configuration Debug -sdk iphonesimulator -destination "platform=iOS Simulator,name=iPhone 15 Pro Max" build

        - name: Save Build Artifacts        
          uses: actions/upload-artifact@v4      
          with:          
            name: xcode-build          
            path: platforms/ios/build
    deploy:
      needs: build
      runs-on: macos-latest
      steps:
        - uses: actions/checkout@v4      
        - name: Download Build Artifacts        
          uses: actions/download-artifact@v4
          with:          
            name: xcode-build
        - name: list files
          run: ls -la
        - name: Install Fastlane        
          run: |
            sudo gem install fastlane -NV
        - name: Create IPA        
          run: |
            cd platforms/ios
            fastlane gym --scheme "WeSign QA" --workspace "WeSign QA.xcworkspace"
            
